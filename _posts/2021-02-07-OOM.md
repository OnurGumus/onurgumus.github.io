---

layout: default

title: Out-of-Order Execution: An example
description : "A demonstration of how OOM causes problems"
date: 2021-02-07-00:00:00 -0000

comments: true

published: false

image: posts/2021-01-31-What-the-F/wheel.png

excerpt_separator: <!--more-->

---

# Out-of-Order Execution: An example"


Please take a look at below code and try to guess the output:

```csharp
using System;
using System.Threading;
using System.Threading.Tasks;

namespace MemoryBarriers
{
     class Program
    {
        static volatile int x, y, a, b;
        static void Main()
        {
            while (true)
            {
                var t1 = Task.Run(Test1);
                var t2 = Task.Run(Test2);
                Task.WaitAll(t1, t2);
                if (a == 0 && b == 0)
                {
                    Console.WriteLine("{0}, {1}", a, b);
                }
                x = y = a = b = 0;
            }
        }

        static void Test1()
        {
            x = 1;
           // Interlocked.MemoryBarrierProcessWide();
            a = y;
        }

        static void Test2()
        {
            y = 1;
            b = x;
        }
    }
}
```
In the above code, we have defined 4 fields x,y,a and b which are initialized to 0, don't mind the volatile now as we will see **volatile** keyword makes no difference here. Then we create 2 tasks calling Test1 and Test2 respectively and wait for both tasks to complete. Once both tasks are complete we check if a and b are still 0 and if so we print their values. Finally we reset everything back to 0 and re-run the same loop over and over again.

If you run the above code you will observe the output being many **0, 0**'s are printed. But that is rather surprising and let's see why.
In Test1 we set x to 1 and a to y and Test2 sets y to 1 and b to x and So we have four statements racing and let's see possible scenarios.

### Test1 then Test2:
```
x = 1
a = y
y = 1
b = x
```

In this scenario we assumed Test1 finished before Test2, then the final values will be

x = 1, a = 0 , y = 1 , b = 1

### Test2 then Test1:
```
y = 1 
b = x
x = 1
a = y
```
then

x = 1, a = 1, y = 1, b = 0


### Test2 between Test1:
```
x = 1
y = 1
b = x
a = y
```

x = 1, a = 1, y = 1 and b = 1

### Test1 between Test2
y = 1
x = 1
a = y
b = x


x = 1, a = 1, y = 1 and b = 1

### Test1 interleaving Test2
x = 1
y = 1
a = y
b = x

### Test2 interleaving Test1

y = 1
x = 1
b = x
a = y


x = 1, a = 1, y = 1 and b = 1


I think we have covered all possible scenarios
